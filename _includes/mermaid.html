<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11.9.0/dist/mermaid.esm.min.mjs';
  mermaid.initialize({ 
    startOnLoad: true,
    securityLevel: 'loose',
    theme: 'base',
    logLevel: 'error',
    // Add error callback
    mermaid: {
      callback: function(id) {
        console.log('Diagram rendered:', id);
      }
    },
    // Catch parse errors
    parseError: function(err, hash) {
      console.error('Mermaid Parse Error:', err);
      console.error('Error details:', hash);
      // Display error on page
      document.getElementById('error-display').innerHTML = 
        `<pre style="color:red">${err.message}\n${err.str}</pre>`;
    }
   });

  mermaid.registerIconPacks([
      {
        name: 'logos',
        loader: () =>
          fetch('https://unpkg.com/@iconify-json/logos@1/icons.json').then((res) => res.json()),
      },
  ]);

  document.querySelectorAll('pre > code.language-mermaid').forEach((codeBlock) => {
    codeBlock.parentElement.outerHTML = `<pre class="mermaid">${codeBlock.textContent}</pre>`;
  });
</script>